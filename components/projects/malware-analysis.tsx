"use client"

import { useState } from "react"
import { Card } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Bug, ArrowLeft, AlertTriangle, FileSearch, Eye, Shield } from "lucide-react"
import Link from "next/link"

export function MalwareAnalysis() {
  const [analyzing, setAnalyzing] = useState(false)
  const [analysisComplete, setAnalysisComplete] = useState(false)
  const [selectedSample, setSelectedSample] = useState<string | null>(null)

  const malwareSamples = [
    {
      id: "sample1",
      name: "trojan_banking.exe",
      type: "Trojan Bancaire",
      hash: "d41d8cd98f00b204e9800998ecf8427e",
      size: "2.3 MB",
      detected: "18/70 antivirus",
      severity: "Critique",
      behavior: [
        "Modification du registre Windows",
        "Injection de code dans explorer.exe",
        "Communication avec C&C: 203.0.113.45:8080",
        "Keylogging actif sur navigateurs",
        "Capture d'écran périodique",
      ],
      indicators: [
        "Persistance: HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
        "Mutex: Global\\BankingTrojan2023",
        "Network: Beacon toutes les 60 secondes",
        "Files: %APPDATA%\\svchost.exe (copie du malware)",
      ],
    },
    {
      id: "sample2",
      name: "ransomware_lock.bin",
      type: "Ransomware",
      hash: "098f6bcd4621d373cade4e832627b4f6",
      size: "1.8 MB",
      detected: "45/70 antivirus",
      severity: "Critique",
      behavior: [
        "Chiffrement AES-256 des fichiers utilisateur",
        "Suppression des shadow copies Windows",
        "Affichage de note de rançon",
        "Communication avec serveur de paiement Tor",
        "Extension des fichiers: .locked",
      ],
      indicators: [
        "Persistence: Service Windows 'WindowsUpdateService'",
        "Network: Connexion Tor hidden service",
        "Crypto: Wallet Bitcoin inclus dans la note",
        "Files: C:\\Users\\Public\\README_DECRYPT.txt",
      ],
    },
    {
      id: "sample3",
      name: "worm_network.dll",
      type: "Ver Réseau",
      hash: "5d41402abc4b2a76b9719d911017c592",
      size: "850 KB",
      detected: "32/70 antivirus",
      severity: "Haute",
      behavior: [
        "Scan du réseau local (192.168.0.0/16)",
        "Exploitation EternalBlue (MS17-010)",
        "Propagation via partages SMB",
        "Installation de backdoor",
        "Désactivation de l'antivirus Windows Defender",
      ],
      indicators: [
        "Network: Scan massif des ports 445, 139",
        "Exploitation: MS17-010 (SMBv1)",
        "Persistence: DLL sideloading dans System32",
        "Lateral Movement: PsExec-like behavior",
      ],
    },
  ]

  const tools = [
    { name: "VirusTotal", description: "Analyse multi-antivirus en ligne", icon: FileSearch },
    { name: "Cuckoo Sandbox", description: "Sandbox d'analyse dynamique", icon: Eye },
    { name: "IDA Pro", description: "Désassembleur et debugger", icon: Bug },
    { name: "Wireshark", description: "Analyse du trafic réseau", icon: Shield },
  ]

  const analysisSteps = [
    {
      step: 1,
      title: "Analyse Statique",
      description: "Extraction des strings, hash, imports, resources, PE headers",
      duration: "15 min",
    },
    {
      step: 2,
      title: "Analyse Dynamique",
      description: "Exécution en sandbox isolée, monitoring comportemental",
      duration: "30 min",
    },
    {
      step: 3,
      title: "Analyse Réseau",
      description: "Capture du trafic, identification des C&C, protocoles utilisés",
      duration: "20 min",
    },
    {
      step: 4,
      title: "Analyse Mémoire",
      description: "Dump mémoire, recherche de code injecté, artifacts",
      duration: "25 min",
    },
    {
      step: 5,
      title: "Rapport & IoCs",
      description: "Documentation complète, IoCs (IP, hash, mutex, registry)",
      duration: "40 min",
    },
  ]

  const handleAnalyze = () => {
    setAnalyzing(true)
    setAnalysisComplete(false)
    setTimeout(() => {
      setAnalyzing(false)
      setAnalysisComplete(true)
    }, 5000)
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case "Critique":
        return "text-red-500 border-red-500 bg-red-500/10"
      case "Haute":
        return "text-orange-500 border-orange-500 bg-orange-500/10"
      case "Moyenne":
        return "text-yellow-500 border-yellow-500 bg-yellow-500/10"
      default:
        return "text-blue-500 border-blue-500 bg-blue-500/10"
    }
  }

  return (
    <div className="min-h-screen bg-black text-white py-12 px-4">
      <div className="max-w-6xl mx-auto">
        <Link href="/#projects">
          <Button variant="ghost" className="mb-8 text-cyan-400 hover:text-cyan-300 hover:bg-cyan-400/10">
            <ArrowLeft className="mr-2 h-4 w-4" /> Retour aux projets
          </Button>
        </Link>

        <div className="mb-12">
          <div className="flex items-center gap-4 mb-4">
            <div className="p-3 bg-cyan-400/10 rounded-lg">
              <Bug className="h-10 w-10 text-cyan-400" />
            </div>
            <div>
              <h1 className="text-4xl font-bold mb-2 text-cyan-400">Analyse de Malware - Environnement Contrôlé</h1>
              <p className="text-gray-400">Formation BTS CIEL - 2025 • Reverse Engineering & Threat Analysis</p>
            </div>
          </div>

          <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6 mb-8">
            <h3 className="text-xl font-semibold mb-4 text-cyan-400">Description du Projet</h3>
            <p className="text-gray-300 mb-4">
              Analyse approfondie de 3 échantillons de malware dans un environnement isolé (VM + sandbox). Le projet
              couvre l'analyse statique et dynamique, l'identification des IoCs (Indicators of Compromise), la
              documentation des comportements malveillants et la création de règles de détection YARA.
            </p>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
              <div className="text-center">
                <p className="text-3xl font-bold text-cyan-400">3</p>
                <p className="text-sm text-gray-400">Échantillons analysés</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-green-400">5</p>
                <p className="text-sm text-gray-400">Phases d'analyse</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-yellow-400">15+</p>
                <p className="text-sm text-gray-400">IoCs identifiés</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold text-cyan-400">100%</p>
                <p className="text-sm text-gray-400">Environnement isolé</p>
              </div>
            </div>
          </Card>
        </div>

        <div className="mb-8">
          <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6">
            <h3 className="text-xl font-semibold mb-4 text-cyan-400 flex items-center gap-2">
              <FileSearch className="h-5 w-5" />
              Analyseur de Malware (Sandbox Simulation)
            </h3>
            <div className="bg-black/60 rounded-lg p-4 mb-4 font-mono text-sm">
              <p className="text-green-400">$ cuckoo submit suspicious_file.exe --package exe</p>
              {analyzing && (
                <div className="mt-4 space-y-2">
                  <p className="text-gray-400">[*] Starting analysis task #12345...</p>
                  <p className="text-gray-400">[*] Launching VM snapshot...</p>
                  <p className="text-gray-400">[*] Executing sample in isolated environment...</p>
                  <p className="text-gray-400">[*] Monitoring file system activity...</p>
                  <p className="text-gray-400">[*] Capturing network traffic...</p>
                  <p className="text-cyan-400 animate-pulse">[*] Analysis in progress...</p>
                </div>
              )}
              {analysisComplete && (
                <div className="mt-4 space-y-1 text-xs">
                  <p className="text-green-400">[+] Analysis completed successfully</p>
                  <p className="text-red-400">[!] MALICIOUS: Trojan.Win32.Banking detected</p>
                  <p className="text-yellow-400">[!] 12 malicious behaviors identified</p>
                  <p className="text-yellow-400">[!] Network connection to C&C: 203.0.113.45:8080</p>
                  <p className="text-yellow-400">[!] Registry modifications detected</p>
                  <p className="text-cyan-400">[*] Report: /var/lib/cuckoo/storage/analyses/12345/</p>
                  <p className="text-green-400">[+] YARA rule generated automatically</p>
                </div>
              )}
            </div>
            <Button
              onClick={handleAnalyze}
              disabled={analyzing}
              className="bg-cyan-400 hover:bg-cyan-500 text-black font-semibold"
            >
              {analyzing ? "Analyse en cours..." : analysisComplete ? "Relancer l'analyse" : "Lancer l'analyse"}
            </Button>
          </Card>
        </div>

        <div className="grid md:grid-cols-2 gap-6 mb-8">
          <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6">
            <h3 className="text-xl font-semibold mb-4 text-cyan-400">Outils d'Analyse</h3>
            <div className="space-y-3">
              {tools.map((tool) => {
                const Icon = tool.icon
                return (
                  <div key={tool.name} className="flex items-start gap-3 p-3 bg-black/40 rounded-lg">
                    <Icon className="h-5 w-5 text-cyan-400 mt-0.5 flex-shrink-0" />
                    <div>
                      <p className="font-semibold text-white">{tool.name}</p>
                      <p className="text-sm text-gray-400">{tool.description}</p>
                    </div>
                  </div>
                )
              })}
            </div>
          </Card>

          <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6">
            <h3 className="text-xl font-semibold mb-4 text-cyan-400">Méthodologie d'Analyse</h3>
            <div className="space-y-3">
              {analysisSteps.map((step) => (
                <div key={step.step} className="border-l-2 border-cyan-400 pl-4">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-cyan-400 font-bold">#{step.step}</span>
                    <span className="font-semibold text-white">{step.title}</span>
                    <Badge className="bg-cyan-400/10 text-cyan-400 border-cyan-400/30 text-xs ml-auto">
                      {step.duration}
                    </Badge>
                  </div>
                  <p className="text-sm text-gray-400">{step.description}</p>
                </div>
              ))}
            </div>
          </Card>
        </div>

        <h2 className="text-2xl font-bold mb-6 text-cyan-400">Échantillons Analysés</h2>
        <div className="space-y-4 mb-8">
          {malwareSamples.map((sample) => (
            <Card
              key={sample.id}
              className="bg-[#1a1a1a] border-cyan-400/20 p-6 cursor-pointer hover:border-cyan-400 transition-colors"
              onClick={() => setSelectedSample(selectedSample === sample.id ? null : sample.id)}
            >
              <div className="flex items-start justify-between mb-3">
                <div className="flex items-center gap-3 flex-1">
                  <AlertTriangle className="h-6 w-6 text-red-400 flex-shrink-0" />
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-white mb-1">{sample.name}</h3>
                    <div className="flex flex-wrap gap-3 text-sm text-gray-400">
                      <span>Type: {sample.type}</span>
                      <span>Taille: {sample.size}</span>
                      <span>Détection: {sample.detected}</span>
                    </div>
                    <p className="text-xs text-gray-500 mt-1 font-mono">SHA256: {sample.hash}</p>
                  </div>
                </div>
                <Badge className={getSeverityColor(sample.severity)}>{sample.severity}</Badge>
              </div>

              {selectedSample === sample.id && (
                <div className="mt-4 pt-4 border-t border-gray-700 space-y-4">
                  <div>
                    <h4 className="font-semibold text-cyan-400 mb-2 flex items-center gap-2">
                      <Eye className="h-4 w-4" />
                      Comportements Détectés:
                    </h4>
                    <ul className="space-y-1">
                      {sample.behavior.map((behavior, idx) => (
                        <li key={idx} className="text-sm text-gray-300 flex items-start gap-2">
                          <span className="text-red-400 mt-1">•</span>
                          <span>{behavior}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                  <div>
                    <h4 className="font-semibold text-cyan-400 mb-2 flex items-center gap-2">
                      <Shield className="h-4 w-4" />
                      Indicators of Compromise (IoCs):
                    </h4>
                    <ul className="space-y-1">
                      {sample.indicators.map((indicator, idx) => (
                        <li key={idx} className="text-sm text-gray-300 bg-black/40 rounded p-2 font-mono">
                          {indicator}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              )}
            </Card>
          ))}
        </div>

        <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6 mb-8">
          <h3 className="text-xl font-semibold mb-4 text-cyan-400">Règle YARA Exemple (Trojan Bancaire)</h3>
          <div className="bg-black/60 rounded p-4 text-xs font-mono overflow-x-auto">
            <pre className="text-gray-300">{`rule TrojanBanking_Sample1 {
    meta:
        description = "Détection du trojan bancaire analysé"
        author = "Redouane Sahari"
        date = "2025-01-15"
        severity = "critical"
    
    strings:
        $mutex = "Global\\\\BankingTrojan2023" wide
        $c2 = "203.0.113.45" ascii
        $reg_key = "CurrentVersion\\\\Run" ascii nocase
        $keylog = { 6A 00 68 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? 85 C0 }
    
    condition:
        uint16(0) == 0x5A4D and // MZ header
        filesize < 5MB and
        2 of them
}`}</pre>
          </div>
        </Card>

        <Card className="bg-[#1a1a1a] border-cyan-400/20 p-6">
          <h3 className="text-xl font-semibold mb-4 text-cyan-400">Compétences Développées</h3>
          <div className="flex flex-wrap gap-2">
            {[
              "Malware Analysis",
              "Cuckoo Sandbox",
              "Static Analysis",
              "Dynamic Analysis",
              "IDA Pro",
              "Reverse Engineering",
              "PE Analysis",
              "YARA Rules",
              "IoC Extraction",
              "Network Forensics",
              "Memory Forensics",
              "Threat Intelligence",
              "VirusTotal",
              "Wireshark",
            ].map((skill) => (
              <Badge key={skill} className="bg-cyan-400/10 text-cyan-400 border-cyan-400/30">
                {skill}
              </Badge>
            ))}
          </div>
        </Card>
      </div>
    </div>
  )
}
